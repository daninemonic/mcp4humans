<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        body {
            font-family: var(--vscode-font-family);
            font-size: var(--vscode-font-size);
            color: var(--vscode-foreground);
            background-color: var(--vscode-editor-background);
            padding: 20px;
        }

        .header {
            margin-bottom: 20px;
        }

        .title {
            font-size: 1.5em;
            font-weight: bold;
            margin: 0;
        }

        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid var(--vscode-panel-border);
            border-right: 1px solid var(--vscode-panel-border);
        }

        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            background-color: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
            border-radius: 2px;
        }

        input[type="text"]:focus,
        textarea:focus {
            outline: 1px solid var(--vscode-focusBorder);
        }

        .radio-group {
            display: flex;
            gap: 15px;
        }

        .radio-option {
            display: flex;
            align-items: center;
        }

        .radio-option input {
            margin-right: 5px;
            margin-top: 0;
        }

        .radio-option label {
            display: inline;
            margin-bottom: 0;
            line-height: 1;
        }

        button {
            background-color: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 2px;
            margin-right: 10px;
        }

        button:hover {
            background-color: var(--vscode-button-hoverBackground);
        }

        .button-container {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .error {
            color: var(--vscode-errorForeground);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .required {
            color: var(--vscode-errorForeground);
            margin-left: 3px;
        }

        .json-input {
            font-family: monospace;
            height: 150px;
            white-space: pre;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--vscode-progressBar-background);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
        }

        th {
            border-bottom: 1px solid var(--vscode-panel-border);
        }

        .trash-icon {
            cursor: pointer;
            color: var(--vscode-errorForeground);
            font-size: 14px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .trash-icon:hover {
            background-color: var(--vscode-editor-selectionBackground);
        }
    </style>
</head>

<body>
    <div class="header">
        <h1 class="title">${title}</h1>
    </div>

    <div class="section">
        <h2 class="section-title">Import Configuration</h2>
        <div class="form-group">
            <label for="json-config">Paste JSON Configuration</label>
            <textarea id="json-config" class="json-input"
                placeholder='{"mcpServers":{"server-name":{"cmd": "npx","args":["-y", "@package"]}}}'
                rows="10"></textarea>
        </div>
        <div style="text-align: right;">
            <button id="parse-json-button">Parse JSON</button>
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">Basic Information</h2>
        <div class="form-group">
            <label for="server-name">Server Name<span class="required">*</span></label>
            <input type="text" id="server-name" value="${serverName}" />
            ${nameError}
        </div>
        <div class="form-group">
            <label for="server-description">Description</label>
            <input type="text" id="server-description" value="${serverDescription}" />
        </div>
    </div>

    <div class="section">
        <h2 class="section-title">Transport Type<span class="required">*</span></h2>
        <div class="form-group">
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" id="transport-stdio" name="transport-type" value="stdio" ${stdioChecked} />
                    <label for="transport-stdio">STDIO</label>
                </div>
                <div class="radio-option">
                    <input type="radio" id="transport-sse" name="transport-type" value="sse" ${sseChecked} />
                    <label for="transport-sse">SSE</label>
                </div>
            </div>
            ${transportTypeError}
        </div>
    </div>

    <div id="stdio-config" class="section ${stdioHidden}">
        <h2 class="section-title">STDIO Configuration</h2>
        <div class="form-group">
            <label for="stdio-cmd">Command<span class="required">*</span></label>
            <input type="text" id="stdio-cmd" value="${stdioCmd}" />
            ${stdioCmdError}
        </div>
        <div class="form-group">
            <label for="stdio-args">Arguments (comma separated)<span class="required">*</span></label>
            <input type="text" id="stdio-args" value="${stdioArgs}" />
        </div>
        <div class="form-group">
            <label for="stdio-cwd">Working Directory</label>
            <input type="text" id="stdio-cwd" value="${stdioCwd}" />
        </div>
        <div class="form-group">
            <label>Environment Variables</label>
            <table id="env-vars-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Value</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="env-vars-body">
                    ${stdioEnvVars}
                </tbody>
            </table>
            <div style="margin-top: 10px;">
                <button id="add-env-var-btn">Add Environment Variable</button>
            </div>
        </div>
    </div>

    <div id="sse-config" class="section ${sseHidden}">
        <h2 class="section-title">SSE Configuration</h2>
        <div class="form-group">
            <label for="sse-url">URL<span class="required">*</span></label>
            <input type="text" id="sse-url" value="${sseUrl}" />
            ${sseUrlError}
        </div>
        <div class="form-group">
            <label>Headers</label>
            <table id="headers-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Value</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="headers-body">
                    ${sseHeaders}
                </tbody>
            </table>
            <div style="margin-top: 10px;">
                <button id="add-header-btn">Add Header</button>
            </div>
        </div>
    </div>

    <div class="button-container">
        <button id="connect-btn">Connect</button>
        <button id="cancel-btn">Cancel</button>
    </div>

    ${loadingSpinner}

    <script>
        const vscode = acquireVsCodeApi();

        // Get form elements
        const transportRadios = document.querySelectorAll('input[name="transport-type"]');
        const stdioConfig = document.getElementById('stdio-config');
        const sseConfig = document.getElementById('sse-config');

        // Show/hide configuration sections based on transport type
        transportRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'stdio') {
                    stdioConfig.classList.remove('hidden');
                    sseConfig.classList.add('hidden');
                } else {
                    stdioConfig.classList.add('hidden');
                    sseConfig.classList.remove('hidden');
                }
            });
        });

        // Add environment variable
        document.getElementById('add-env-var-btn').addEventListener('click', () => {
            const tbody = document.getElementById('env-vars-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="env-name" /></td>
                <td><input type="text" class="env-value" /></td>
                <td><div class="trash-icon remove-env-btn">🗑️</div></td>
            `;
            tbody.appendChild(row);

            // Add event listener to the new remove button
            row.querySelector('.remove-env-btn').addEventListener('click', () => {
                row.remove();
            });
        });

        // Add header
        document.getElementById('add-header-btn').addEventListener('click', () => {
            const tbody = document.getElementById('headers-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="header-name" /></td>
                <td><input type="text" class="header-value" /></td>
                <td><div class="trash-icon remove-header-btn">🗑️</div></td>
            `;
            tbody.appendChild(row);

            // Add event listener to the new remove button
            row.querySelector('.remove-header-btn').addEventListener('click', () => {
                row.remove();
            });
        });

        // Add event listeners to existing remove buttons
        document.querySelectorAll('.remove-env-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('tr').remove();
            });
        });

        document.querySelectorAll('.remove-header-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('tr').remove();
            });
        });

        // Parse JSON button
        document.getElementById('parse-json-button').addEventListener('click', () => {
            const jsonText = document.getElementById('json-config').value;
            if (jsonText.trim()) {
                vscode.postMessage({
                    command: 'parseJson',
                    json: jsonText
                });
            }
        });

        // Connect button
        document.getElementById('connect-btn').addEventListener('click', () => {
            const server = getServerConfig();
            vscode.postMessage({
                command: 'connectAndSave',
                server
            });
        });

        // Cancel button
        document.getElementById('cancel-btn').addEventListener('click', () => {
            vscode.postMessage({
                command: 'cancel'
            });
        });

        // Get server configuration from form
        function getServerConfig() {
            const name = document.getElementById('server-name').value;
            const description = document.getElementById('server-description').value;
            const transportType = document.querySelector('input[name="transport-type"]:checked').value;

            const server = {
                name,
                description,
                transportType
            };

            if (transportType === 'stdio') {
                const cmd = document.getElementById('stdio-cmd').value;
                const argsStr = document.getElementById('stdio-args').value;
                const args = argsStr ? argsStr.split(',').map(arg => arg.trim()) : [];
                const cwd = document.getElementById('stdio-cwd').value;

                const environment = {};
                document.querySelectorAll('#env-vars-body tr').forEach(row => {
                    const name = row.querySelector('.env-name').value;
                    const value = row.querySelector('.env-value').value;
                    if (name) {
                        environment[name] = value;
                    }
                });

                server.stdioConfig = {
                    cmd,
                    args,
                    cwd: cwd || null,
                    environment: Object.keys(environment).length > 0 ? environment : null
                };
            } else if (transportType === 'sse') {
                const url = document.getElementById('sse-url').value;

                const headers = {};
                document.querySelectorAll('#headers-body tr').forEach(row => {
                    const name = row.querySelector('.header-name').value;
                    const value = row.querySelector('.header-value').value;
                    if (name) {
                        headers[name] = value;
                    }
                });

                server.sseConfig = {
                    url,
                    headers: Object.keys(headers).length > 0 ? headers : null
                };
            }

            return server;
        }
    </script>
</body>

</html>